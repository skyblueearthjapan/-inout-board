<script>
/**
 * 外出記入板 フロントエンドJS
 */
(function() {
  'use strict';

  // ========================================
  // 状態管理
  // ========================================
  let currentDate = INITIAL_DATE;
  let currentData = null;

  // ========================================
  // DOM要素
  // ========================================
  const elements = {
    dateInput: null,
    reloadBtn: null,
    clearAllBtn: null,
    statusMessage: null,
    loading: null,
    tableContainer: null,
    tableBody: null
  };

  // ========================================
  // 初期化
  // ========================================
  document.addEventListener('DOMContentLoaded', init);

  function init() {
    // DOM要素を取得
    elements.dateInput = document.getElementById('dateInput');
    elements.reloadBtn = document.getElementById('reloadBtn');
    elements.clearAllBtn = document.getElementById('clearAllBtn');
    elements.statusMessage = document.getElementById('statusMessage');
    elements.loading = document.getElementById('loading');
    elements.tableContainer = document.getElementById('tableContainer');
    elements.tableBody = document.getElementById('tableBody');

    // 日付入力を初期化
    elements.dateInput.value = currentDate;

    // イベントリスナー
    elements.dateInput.addEventListener('change', onDateChange);
    elements.reloadBtn.addEventListener('click', loadData);
    elements.clearAllBtn.addEventListener('click', clearAllRows);

    // 初期データ読み込み
    loadData();
  }

  // ========================================
  // データ読み込み
  // ========================================
  function loadData() {
    showLoading(true);
    hideStatus();

    google.script.run
      .withSuccessHandler(onDataLoaded)
      .withFailureHandler(onError)
      .getDayData(currentDate);
  }

  function onDataLoaded(data) {
    currentData = data;
    renderTable(data.rows);
    showLoading(false);
    showStatus('データを読み込みました', 'success', 2000);
  }

  // ========================================
  // 日付変更
  // ========================================
  function onDateChange(e) {
    currentDate = e.target.value;
    loadData();
  }

  // ========================================
  // テーブル描画
  // ========================================
  function renderTable(rows) {
    elements.tableBody.innerHTML = '';

    rows.forEach(row => {
      const tr = createTableRow(row);
      // 名前がない行は非表示（ホワイトボードに合わせる）
      if (tr) {
        elements.tableBody.appendChild(tr);
      }
    });

    elements.tableContainer.classList.remove('hidden');
    elements.tableContainer.classList.add('fade-in');
  }

  function createTableRow(row) {
    // 名前がない行はスキップ（ホワイトボードに合わせる）
    if (!row.name || row.name.trim() === '') {
      return null;
    }

    const tr = document.createElement('tr');
    tr.dataset.rowIndex = row.rowIndex;

    // ステータスに応じたクラス
    tr.className = getRowClass(row);

    // 名前セル（編集不可）
    const nameTd = document.createElement('td');
    nameTd.className = 'name-cell';
    nameTd.textContent = row.name || '';
    tr.appendChild(nameTd);

    // 行先（プレースホルダなし、cell-input + destination）
    tr.appendChild(createInputCell('destination', row.destination, '', 'destination'));

    // 出社日（日付ピッカー、date-cell）
    tr.appendChild(createDateInputCell('startTime', row.startTime, 'date-cell'));

    // 帰社時刻（時刻入力、time-cell）
    tr.appendChild(createTimeInputCell('endTime', row.endTime, 'time-cell'));

    // 備考（プレースホルダなし、note-cell）
    tr.appendChild(createInputCell('note', row.note, '', 'note-cell'));

    // 操作ボタン（保存・クリア）
    const actionTd = document.createElement('td');
    actionTd.className = 'action-cell';

    const saveBtn = document.createElement('button');
    saveBtn.className = 'save-btn';
    saveBtn.textContent = '保存';
    saveBtn.addEventListener('click', () => saveRow(row.rowIndex));
    actionTd.appendChild(saveBtn);

    const clearBtn = document.createElement('button');
    clearBtn.className = 'clear-btn';
    clearBtn.textContent = 'クリア';
    clearBtn.addEventListener('click', () => clearRow(row.rowIndex));
    actionTd.appendChild(clearBtn);

    tr.appendChild(actionTd);

    return tr;
  }

  function createInputCell(fieldName, value, placeholder, tdClass) {
    const td = document.createElement('td');
    if (tdClass) {
      td.className = tdClass;
    }

    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'cell-input' + (fieldName === 'destination' ? ' destination' : '');
    input.name = fieldName;
    input.value = value || '';
    if (placeholder) {
      input.placeholder = placeholder;
    }

    // Enterキーで保存
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const row = e.target.closest('tr');
        const rowIndex = parseInt(row.dataset.rowIndex);
        saveRow(rowIndex);
      }
    });

    td.appendChild(input);
    return td;
  }

  function createDateInputCell(fieldName, value, tdClass) {
    const td = document.createElement('td');
    if (tdClass) {
      td.className = tdClass;
    }

    const input = document.createElement('input');
    input.type = 'date';  // 日付ピッカー
    input.className = 'cell-input';
    input.name = fieldName;
    input.value = value || '';

    // Enterキーで保存
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const row = e.target.closest('tr');
        const rowIndex = parseInt(row.dataset.rowIndex);
        saveRow(rowIndex);
      }
    });

    td.appendChild(input);
    return td;
  }

  function createTimeInputCell(fieldName, value, tdClass) {
    const td = document.createElement('td');
    if (tdClass) {
      td.className = tdClass;
    }

    const input = document.createElement('input');
    input.type = 'time';  // タイムピッカー（プルダウン＋手動入力可能）
    input.className = 'cell-input';
    input.name = fieldName;
    input.value = value || '';

    // Enterキーで保存
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const row = e.target.closest('tr');
        const rowIndex = parseInt(row.dataset.rowIndex);
        saveRow(rowIndex);
      }
    });

    td.appendChild(input);
    return td;
  }

  function getRowClass(row) {
    // 名前がない行は空行
    if (!row.name || row.name.trim() === '') {
      return 'row-empty';
    }

    // 帰社時刻がある → 日帰り（緑色）
    if (row.endTime && row.endTime.trim() !== '') {
      return 'row-back';  // 緑色
    }

    // 出社日があって帰社時刻がない → 宿泊あり（黄色）
    if (row.startTime && row.startTime.trim() !== '') {
      return 'row-out';  // 黄色
    }

    // どちらもない → 通常
    return 'row-none';
  }

  // ========================================
  // 時刻入力の自動整形
  // ========================================
  function formatTimeInput(value) {
    if (!value || value.trim() === '') {
      return '';
    }

    const trimmed = value.trim();

    // すでに正しい形式なら何もしない
    if (/^([01]?\d|2[0-3]):[0-5]\d$/.test(trimmed)) {
      // HH:MM形式に整形（1桁の時は0埋め）
      const match = trimmed.match(/^(\d{1,2}):(\d{2})$/);
      if (match) {
        const hours = match[1].padStart(2, '0');
        const minutes = match[2];
        return hours + ':' + minutes;
      }
      return trimmed;
    }

    // H:M形式（例: 9:5）を HH:MM に変換
    const match = trimmed.match(/^(\d{1,2}):(\d{1,2})$/);
    if (match) {
      const hours = parseInt(match[1]);
      const minutes = parseInt(match[2]);

      // 時間のバリデーション
      if (hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
        return hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0');
      }
    }

    // 整形できない場合はそのまま返す（バリデーションエラーは保存時に出す）
    return null;
  }

  // ========================================
  // 全行クリア
  // ========================================
  function clearAllRows() {
    if (!confirm('すべての行の情報をクリアしますか？（名前以外）\n\nこの操作は取り消せません。')) {
      return;
    }

    const rows = elements.tableBody.querySelectorAll('tr');
    if (rows.length === 0) {
      showStatus('クリアする行がありません', 'info', 2000);
      return;
    }

    // すべてクリアボタンを無効化
    elements.clearAllBtn.disabled = true;
    elements.clearAllBtn.textContent = 'クリア中...';

    let completed = 0;
    const total = rows.length;

    rows.forEach((tr) => {
      const rowIndex = parseInt(tr.dataset.rowIndex);

      // 空のデータで保存
      const payload = {
        rowIndex: rowIndex,
        destination: '',
        startTime: '',
        endTime: '',
        note: ''
      };

      google.script.run
        .withSuccessHandler(function(updatedRow) {
          completed++;
          updateRowDisplay(tr, updatedRow);
          tr.className = getRowClass(updatedRow);

          if (completed === total) {
            elements.clearAllBtn.disabled = false;
            elements.clearAllBtn.textContent = 'すべてクリア';
            showStatus('すべての行をクリアしました', 'success', 2000);
          }
        })
        .withFailureHandler(function(error) {
          completed++;
          console.error('Error clearing row:', error);

          if (completed === total) {
            elements.clearAllBtn.disabled = false;
            elements.clearAllBtn.textContent = 'すべてクリア';
            showStatus('一部の行のクリアに失敗しました', 'error');
          }
        })
        .updateRow(currentDate, payload);
    });
  }

  // ========================================
  // 行クリア
  // ========================================
  function clearRow(rowIndex) {
    if (!confirm('この行の情報をクリアしますか？（名前以外）')) {
      return;
    }

    const tr = elements.tableBody.querySelector(`tr[data-row-index="${rowIndex}"]`);
    if (!tr) return;

    // 入力フィールドを空にする
    const inputs = tr.querySelectorAll('input');
    inputs[0].value = '';  // 行先
    inputs[1].value = '';  // 出社日
    inputs[2].value = '';  // 帰社時刻
    inputs[3].value = '';  // 備考

    // 空のデータで保存
    const payload = {
      rowIndex: rowIndex,
      destination: '',
      startTime: '',
      endTime: '',
      note: ''
    };

    // 保存中状態
    tr.classList.add('row-saving');
    const saveBtn = tr.querySelector('.save-btn');
    const clearBtn = tr.querySelector('.clear-btn');
    saveBtn.disabled = true;
    clearBtn.disabled = true;

    google.script.run
      .withSuccessHandler(function(updatedRow) {
        onRowSaved(updatedRow, tr, saveBtn);
        clearBtn.disabled = false;
      })
      .withFailureHandler(function(error) {
        onSaveError(error, tr, saveBtn);
        clearBtn.disabled = false;
      })
      .updateRow(currentDate, payload);
  }

  // ========================================
  // 行保存
  // ========================================
  function saveRow(rowIndex) {
    const tr = elements.tableBody.querySelector(`tr[data-row-index="${rowIndex}"]`);
    if (!tr) return;

    // 入力値を取得
    const inputs = tr.querySelectorAll('input');
    const payload = {
      rowIndex: rowIndex,
      destination: inputs[0].value,
      startTime: inputs[1].value,
      endTime: inputs[2].value,
      note: inputs[3].value
    };

    // クライアント側バリデーション
    const validationResult = validatePayload(payload);
    if (!validationResult.valid) {
      showStatus(validationResult.message, 'error');
      return;
    }

    // 保存中状態
    tr.classList.add('row-saving');
    const saveBtn = tr.querySelector('.save-btn');
    saveBtn.disabled = true;
    saveBtn.textContent = '保存中...';

    google.script.run
      .withSuccessHandler(function(updatedRow) {
        onRowSaved(updatedRow, tr, saveBtn);
      })
      .withFailureHandler(function(error) {
        onSaveError(error, tr, saveBtn);
      })
      .updateRow(currentDate, payload);
  }

  function onRowSaved(updatedRow, tr, saveBtn) {
    // 行を更新
    updateRowDisplay(tr, updatedRow);

    // 状態を戻す
    tr.classList.remove('row-saving');
    saveBtn.disabled = false;
    saveBtn.textContent = '保存';

    // ハイライトアニメーション
    tr.classList.add('row-updated');
    setTimeout(() => tr.classList.remove('row-updated'), 1000);

    showStatus('保存しました', 'success', 2000);
  }

  function onSaveError(error, tr, saveBtn) {
    tr.classList.remove('row-saving');
    saveBtn.disabled = false;
    saveBtn.textContent = '保存';
    showStatus('エラー: ' + error.message, 'error');
  }

  function updateRowDisplay(tr, row) {
    // 入力値を更新
    const inputs = tr.querySelectorAll('input');
    inputs[0].value = row.destination || '';
    inputs[1].value = row.startTime || '';
    inputs[2].value = row.endTime || '';
    inputs[3].value = row.note || '';

    // クラスを更新
    tr.className = getRowClass(row);
  }

  // ========================================
  // クライアント側バリデーション
  // ========================================
  function validatePayload(payload) {
    const errors = [];

    // 出社日の形式チェック（YYYY-MM-DD）
    if (payload.startTime && !isValidDateFormat(payload.startTime)) {
      errors.push('出社日の形式が不正です（例: 2025-12-25）');
    }

    // 帰社時刻の形式チェック（HH:MM）
    if (payload.endTime && !isValidTimeFormat(payload.endTime)) {
      errors.push('帰社時刻の形式が不正です（例: 17:30 または 09:00）');
    }

    if (errors.length > 0) {
      return { valid: false, message: errors.join('\n') };
    }
    return { valid: true, message: '' };
  }

  function isValidDateFormat(dateStr) {
    if (!dateStr || dateStr.trim() === '') return true;
    // YYYY-MM-DD形式をチェック
    const pattern = /^\d{4}-\d{2}-\d{2}$/;
    if (!pattern.test(dateStr.trim())) return false;

    // 実際に有効な日付かチェック
    const date = new Date(dateStr);
    return !isNaN(date.getTime());
  }

  function isValidTimeFormat(timeStr) {
    if (!timeStr || timeStr.trim() === '') return true;
    const pattern = /^([0-9]|0[0-9]|1[0-9]|2[0-3]):([0-5][0-9])$/;
    return pattern.test(timeStr.trim());
  }

  function normalizeTime(timeStr) {
    if (!timeStr) return '';
    const match = timeStr.trim().match(/^(\d{1,2}):(\d{2})$/);
    if (!match) return timeStr;
    return match[1].padStart(2, '0') + ':' + match[2];
  }

  // ========================================
  // UI ヘルパー
  // ========================================
  function showLoading(show) {
    if (show) {
      elements.loading.classList.remove('hidden');
      elements.tableContainer.classList.add('hidden');
    } else {
      elements.loading.classList.add('hidden');
    }
  }

  function showStatus(message, type, autoHideMs) {
    elements.statusMessage.textContent = message;
    elements.statusMessage.className = 'status-message ' + type;
    elements.statusMessage.classList.remove('hidden');

    if (autoHideMs) {
      setTimeout(hideStatus, autoHideMs);
    }
  }

  function hideStatus() {
    elements.statusMessage.classList.add('hidden');
  }

  function onError(error) {
    showLoading(false);
    showStatus('エラー: ' + error.message, 'error');
    console.error('Error:', error);
  }

})();
</script>
